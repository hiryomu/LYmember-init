<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>初期設定</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:system-ui,sans-serif;padding:16px;background:#f7f7fb;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
.card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,0.06);max-width:520px;width:90%;}
h2{text-align:center;margin-bottom:24px;color:#333;}
label{display:block;margin-top:16px;font-weight:600;color:#444;}
input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #ddd;font-size:16px;box-sizing:border-box;}
input:focus,select:focus{outline:none;border-color:#007bff;box-shadow:0 0 0 2px rgba(0,123,255,0.25);}
button{background:#007bff;color:white;border:none;font-weight:600;cursor:pointer;margin-top:24px;position:relative;}
button:hover{background:#0056b3;}
button:disabled{background:#ccc;cursor:not-allowed;}
.loading{opacity:0.7;pointer-events:none;}
.success{color:#28a745;margin-top:16px;font-weight:700;text-align:center;padding:12px;background-color:rgba(40,167,69,0.1);border-radius:8px;}
.error{color:#dc3545;margin-top:16px;font-weight:700;text-align:center;padding:12px;background-color:rgba(220,53,69,0.1);border-radius:8px;}
</style>
</head>
<body>
<div class="card" id="card">
<h2>初期設定</h2>
<form id="profileForm">
  <label for="nickname">ニックネーム</label>
  <input id="nickname" type="text" placeholder="例: たろう" required>
  <label for="level">レベル</label>
  <select id="level" required>
    <option value="">選んでください</option>
    <option value="5級">5級</option>
    <option value="4級">4級</option>
    <option value="3級">3級</option>
    <option value="準2級">準2級</option>
    <option value="2級">2級</option>
    <option value="準1級">準1級</option>
    <option value="1級">1級</option>
  </select>
  <input type="hidden" id="userId">
  <input type="hidden" id="displayName">
  <button type="submit" id="submitBtn">保存する</button>
</form>
<div id="msg"></div>
</div>

<script>
const LIFF_ID = "2008101239-krV9EGla";
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwFgPReTnR7A20Yv6gX6o1QBa1fQ4-EZHp-bYYdzzYNTyKx72JsSqwbKlOgP_Hc6oNDmA/exec";

const form = document.getElementById('profileForm');
const msgEl = document.getElementById('msg');
const nicknameInput = document.getElementById('nickname');
const levelInput = document.getElementById('level');
const userIdInput = document.getElementById('userId');
const displayNameInput = document.getElementById('displayName');
const submitBtn = document.getElementById('submitBtn');
const card = document.getElementById('card');

function showMsg(text, kind){ msgEl.textContent=text; msgEl.className=kind==='ok'?'success':'error'; }
function setLoading(isLoading){ card.classList.toggle('loading',isLoading); submitBtn.disabled=isLoading; }

async function initLiff(){
  try{
    setLoading(true);
    await liff.init({liffId:LIFF_ID});
    if(!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    userIdInput.value=profile.userId;
    displayNameInput.value=profile.displayName;
    setLoading(false);
  }catch(err){
    console.error(err);
    showMsg("LIFF初期化に失敗しました","error");
    setLoading(false);
  }
}

form.addEventListener('submit',async (e)=>{
  e.preventDefault();
  showMsg('', '');
  setLoading(true);

  if(!nicknameInput.value.trim() || !levelInput.value){ showMsg("入力してください","error"); setLoading(false); return; }

  const params=new URLSearchParams({
    mode:"initdata",
    nickname:nicknameInput.value.trim(),
    level:levelInput.value,
    userId:userIdInput.value,
    displayName:displayNameInput.value
  });

  try{
    const res = await fetch(GAS_WEBAPP_URL+"?"+params.toString());
    const result = await res.json();
   if(result.status==="ok"){
  showMsg("保存しました","ok");
  submitBtn.textContent="保存しました";
  submitBtn.disabled=true;

  // LINEに登録完了メッセージ送信
  if(liff.isInClient() && liff.sendMessages){
    liff.sendMessages([{
      type: 'text',
      text: '登録完了しました！よろしくお願いします。'
    }]).then(()=>{
      console.log("メッセージ送信成功");
      // 3秒後にウィンドウを閉じる
      setTimeout(()=>{ liff.closeWindow(); },3000);
    }).catch(err=>{
      console.error("メッセージ送信失敗:", err);
      setTimeout(()=>{ liff.closeWindow(); },3000);
    });
  } else {
    setTimeout(()=>{ if(liff.isInClient()) liff.closeWindow(); },3000);
  }
}else throw new Error(result.message||"保存に失敗");
  }catch(err){
    console.error(err);
    showMsg("保存に失敗しました: "+err.message,"error");
    setLoading(false);
  }
});

window.addEventListener('load',initLiff);
</script>
</body>
</html>
